_your zenodo badge here_

# Gold-etal_2024_EarthsFuture

**A Multi-site Hidden Markov Model Synthetic Streamflow Generator to Evaluate Multisectoral Drought Vulnerability in Colorado’s West Slope Basins**

David F. Gold<sup>1\*</sup>, Patrick M. Reed <sup>2</sup> and Rohini S. Gupta <sup>2</sup>

<sup>1 </sup> Department of Physical Geography, Faculty of Geosciences, Utrecht University, Utrecht, Netherlands
<sup>2 </sup> School of Civil and Environmental Engineering, Cornell University, Ithaca, NY

\* corresponding author:  d.f.gold@uu.nl

## Abstract
The Colorado River is a lifeline for the American Southwest, supporting over 5.5 million irrigated acres of agricultural land and a population of 40 million people. The state of Colorado’s West Slope Basins - six subbasins of the Colorado River that lie on the western side of the continental divide - are critical headwaters of the Colorado River, delivering over 60% of inflows to the Lower Basin in an average year. The West Slope basins also play a vital role in supporting the state of Colorado’s local economy and natural environment. Agricultural production and recreational activities supported by water resources within the West Slope Basins are estimated to contribute over $6 billion annually to the state’s economy. Streamflow in the West Slope Basins sustains populations of endangered fish not found outside the Colorado River Basin. Balancing the multisectoral water demands in the West Slope Basins is an increasing challenge for water managers. Droughts in the 20th and early 21st centuries reduced reservoir levels, lowered environmental flows, and threatened agricultural production. Internal variability - irreducible uncertainty stemming from interactions across non-linear processes within the hydroclimate system - complicates future vulnerability assessment. The historical streamflow record in the West Slope represents a single realization of an inherently stochastic process, which does not capture the full extent of internal variability. Climate change further complicates drought vulnerability assessment - downscaled climate modeling suggests the potential for significant declines in West Slope streamflows by mid-century.   

This work contributes a detailed analysis of multisectoral drought vulnerability in the West Slope Basins, incorporating internal variability and climate change. We first develop a novel multi-site Hidden Markov Model (HMM) synthetic streamflow generator that captures the internal variability of streamflows across the six West Slope basins. We then route an ensemble of streamflows generated by the HMM generator through StateMod, the state of Colorado’s water model, to evaluate spatially compounding drought impacts across the West Slope Basins. To assess the effects of climate change, we perturb the HMM to generate a climate-adjusted ensemble of streamflows that reflects plausible changes in climate, and evaluate multisectoral impacts using StateMod. Our results show that drought events emerging from the system’s internal variability can have impacts that exceed extreme conditions in the historical record, including unprecedented lows in deliveries to the lower basin, environmental flows, reservoir levels, and agricultural demand satisfaction. Our results further illustrate that plausible climate changes can cause extreme drought impacts observed in the historical record to become routine. These results can inform future Colorado River planning efforts, and our methodology is globally applicable to snow-dominated regions with conflicting multisectoral water demand.


## Journal reference
Gold, D.F, Reed, P.M. & Gupta, R.S. (In Prep). A Multi-site Hidden Markov Model Synthetic Streamflow Generator to Evaluate Multisectoral Drought Vulnerability in Colorado’s West Slope Basins. Earth's Future
## Code reference
References for each minted software release for all code involved.  

These are generated by Zenodo automatically when conducting a release when Zenodo has been linked to your GitHub repository. The Zenodo references are built by setting the author order in order of contribution to the code using the author's GitHub user name.  This citation can, and likely should, be edited without altering the DOI.

If you have modified a codebase that is outside of a formal release, and the modifications are not planned on being merged back into a version, fork the parent repository and add a `.<shortname>` to the version number of the parent and construct your own name.  For example, `v1.2.5.hydro`.

## Data reference

### Input data
Reference for each minted data source for your input data.  For example:

Colorado Decision Support Systems: [https://cdss.colorado.gov/modeling-data/surface-water-statemod](https://cdss.colorado.gov/modeling-data/surface-water-statemod)

### Output data
Reference for each minted data source for your output data.  For example:

## Contributing modeling software
| Model | Version | Repository Link | DOI |
|-------|---------|-----------------|-----|
| StateMod | 15.0 | [https://github.com/OpenCDSS/cdss-app-statemod-fortran](https://github.com/OpenCDSS/cdss-app-statemod-fortran) | - |

## Reproduce my experiment
This experiment has three main phases. First, the multi-site HMM is fit to the historical record of streamflows in the West Slope Basins. This can be done locally on a laptop or desktop. Second, the streamflow ensembles are run through StateMod, and output is collected and compressed. This step must be done on an HPC resource. This experiment was conducted on [The Cube](https://www.cac.cornell.edu/wiki/index.php?title=THECUBE_Cluster) and [Hopper](https://www.cac.cornell.edu/wiki/index.php?title=Hopper_Cluster) clusters at Cornell University. Finally, the StateMod output is post-processed, and figures are generated. This step can be done on a laptop, but is recommended to be completed on a HPC resource. 

### 1. Fit the multi-site HMM and generate synthetic streamflow ensembles
| Script Name | Description | How to Run |
| --- | --- | --- |
| `fit_hmm.py` | Fits the HMM to 75 years of historical record and saves parameters to text files| `python3 fit_hmm.py` |
| `create_synthetic_records.py` | uses the HMM parameters to generate a baseline ensemble of annual streamflow records for each basin | `python3 create_synthetic_records.py` |
| `annual_records_to_xbm.py` | disaggregates baseline synthetic records across space and time and creates StateMod input files (xbm) | `python3 annual_records_to_xbm.py` |
| `create_synthetic_records_climate.py` | applies climate change adjustements the HMM parameters and generates an adjusted ensemble of annual streamflow records for each basin | `python3 create_synthetic_records_climate.py` |
| `annual_records_to_xbm_climate.py` | disaggregates climate adjusted synthetic records across space and time and creates StateMod input files (xbm) | `python3 annual_records_to_xbm_climate.py` |
| `shift_snowmelt_monthly.py` | shifts climate adjusted streamflow records 1 month earlier to account for changes in snowmelt timing | `python3 shift_snowmelt_monthly.py` |

### 2. Run the HMM ensembles through StateMod and compress the data output

1. Download and install StateMod from [Contributing modeling software](#contributing-modeling-software)
2. Navigate to the "fortran" directory, located within the directory you just downloaded (cdss-app-statemod-fortran/src/main/fortran)
3. Open the file called "makefile" and remove the term "-static" from lines 164 and 171
4. Compile the StateMod executable by typing: `make statemod` 
5. Download and install the StateMod input data for each West Slope basin (Upper Colorado, Gunnison, Yampa, White, and San Juan/Dolores) from CDSS [Input data](#input-data) and unzip the files
6. For each basin
   a. Navigate to the "StateMod" directory. For example, for the Gunnison basin, navigate to "gm2015_StateMod_modified/      StateMod".
   b. Create two new directories, one called "baseline_run" and one called "climate_run"
   c. Navigate to "baseline_run" and create a new directory called "generated_input_files", and inside              "generated_input_files" create a directory called "xbm"
   d. Upload the 1000 xbm files generated by the baseline HMM to the xbm directory
   e. Navigate back to the "baseline_run" directory, and create a new directory called "scenarios".
   f. Navigate into "scenarios" and upload the files in "Workflow/StateModProductionRuns" from this repository
   g. Create a Python environment using the requirements.txt file within the Workflow directory of this repository
   h. Run the scripts in the table below
   i. Navigate to the "climate_run" directory (created in step 6b) and repeat steps 6c-g, uploading the 1000 climate-adjusted xbm files in step 6d instead of the baseline scenarios
 8. Repeat step 6 for each basin  

| Script Name | Description | How to Run |
| --- | --- | --- |
| `sim_set_up.` | Creates 1000 directories, titled "S0_1" to "S999_1" and creates a symbolic link to the StateMod executable (step 4) within each directory | `./sim_set_up.sh` |
| `gen_rsp.py` | Fills in a template .rsp file (which controls StatMod runs) | `python3 gen_rsp.py` |

4. Download and unzip the output data from my experiment [Output data](#output-data)
5. Run the following scripts in the `workflow` directory to compare my outputs to those from the publication

| Script Name | Description | How to Run |
| --- | --- | --- |
| `compare.py` | Script to compare my outputs to the original | `python3 compare.py --orig /path/to/original/data.csv --new /path/to/new/data.csv` |

## Reproduce my figures
Use the scripts found in the `figures` directory to reproduce the figures used in this publication.

| Script Name | Description | How to Run |
| --- | --- | --- |
| `generate_figures.py` | Script to generate my figures | `python3 generate_figures.py -i /path/to/inputs -o /path/to/outuptdir` |
